# 🔄 腾讯云自动更新设置指南

## 功能说明

设置自动从 Git 仓库拉取最新代码并重启服务，无需手动操作。

## 快速设置

### 方法一：使用自动设置脚本（推荐）

```bash
# SSH 连接到服务器
ssh user@your-server-ip

# 进入项目目录
cd /opt/polybot

# 确保 auto-update.sh 已上传到服务器
# 然后运行设置脚本
chmod +x setup-auto-update.sh
bash setup-auto-update.sh /opt/polybot 30
```

参数说明：
- 第一个参数：项目目录（默认：/opt/polybot）
- 第二个参数：更新间隔分钟数（默认：30分钟）

### 方法二：手动设置 Crontab

```bash
# 1. 添加执行权限
chmod +x /opt/polybot/auto-update.sh

# 2. 编辑 crontab
crontab -e

# 3. 添加以下行（每 30 分钟检查一次）
*/30 * * * * cd /opt/polybot && bash auto-update.sh >> /opt/polybot/logs/auto-update-cron.log 2>&1

# 保存并退出
```

## 配置选项

### 自定义更新间隔

```bash
# 每 15 分钟检查一次
bash setup-auto-update.sh /opt/polybot 15

# 每小时检查一次
bash setup-auto-update.sh /opt/polybot 60

# 每 5 分钟检查一次（频繁，不推荐）
bash setup-auto-update.sh /opt/polybot 5
```

### 环境变量配置

编辑 `auto-update.sh` 可以修改：

```bash
PROJECT_DIR="${POLYBOT_DIR:-/opt/polybot}"  # 项目目录
BRANCH="${POLYBOT_BRANCH:-main}"            # Git 分支
USE_PM2=true                                 # 是否使用 PM2
PM2_NAME="polybot"                          # PM2 进程名
```

或在运行前设置：

```bash
export POLYBOT_DIR=/opt/polybot
export POLYBOT_BRANCH=main
bash auto-update.sh
```

## 手动执行更新

不需要等待定时任务，可以手动执行：

```bash
cd /opt/polybot
bash auto-update.sh
```

## 查看更新日志

### 自动更新日志

```bash
# 查看更新日志
tail -f /opt/polybot/logs/auto-update.log

# 查看 Crontab 执行日志
tail -f /opt/polybot/logs/auto-update-cron.log
```

### 查看 Crontab 任务

```bash
# 查看所有定时任务
crontab -l

# 查看特定任务
crontab -l | grep auto-update
```

## 管理 Crontab 任务

### 查看任务

```bash
crontab -l
```

### 编辑任务

```bash
crontab -e
```

### 删除所有任务

```bash
crontab -r
```

### 删除特定任务

```bash
# 编辑 crontab，删除对应行
crontab -e
```

## 更新流程说明

自动更新脚本会执行以下步骤：

1. ✅ **检查 Git 仓库状态**
   - 检查是否有未提交的更改
   - 自动备份未提交的更改

2. ✅ **获取远程更新**
   - 从远程仓库拉取最新信息
   - 比较本地和远程版本

3. ✅ **更新代码**
   - 如果有新版本，自动拉取
   - 显示更新内容

4. ✅ **安装依赖**
   - 检查 package.json 是否有变化
   - 自动安装/更新 npm 依赖

5. ✅ **验证代码**
   - 检查代码语法
   - 确保代码可以运行

6. ✅ **重启服务**
   - 如果使用 PM2，自动重启
   - 检查服务运行状态

## 安全特性

- ✅ 自动备份未提交的更改
- ✅ 更新前检查代码有效性
- ✅ 详细的日志记录
- ✅ 错误处理和回滚机制

## 常见问题

### Q: 更新后服务无法启动？

A: 检查日志：
```bash
pm2 logs polybot
tail -f /opt/polybot/logs/auto-update.log
```

### Q: 如何禁用自动更新？

A: 删除 Crontab 任务：
```bash
crontab -e
# 删除包含 auto-update.sh 的行
```

### Q: 更新间隔太频繁？

A: 修改 Crontab 中的时间设置：
```bash
# 从每 30 分钟改为每小时
*/30 * * * *  →  0 * * * *
```

### Q: 只想手动更新？

A: 不设置 Crontab，只手动运行：
```bash
bash auto-update.sh
```

## 高级配置

### 使用 Webhook 触发更新（可选）

如果需要 Git push 时自动触发更新，可以设置 Webhook：

1. 在 GitHub/GitLab 设置 Webhook
2. 指向服务器上的更新接口
3. 收到 Webhook 后执行 `auto-update.sh`

### 更新前备份

脚本已包含自动备份功能，未提交的更改会自动备份到：
```
/opt/polybot/backups/YYYYMMDD_HHMMSS/
```

### 通知功能（可选扩展）

可以在更新脚本中添加通知功能：
- 邮件通知
- 微信/Telegram 通知
- 服务器日志

## 推荐配置

### 生产环境

```bash
# 每 1 小时检查一次（平衡及时性和稳定性）
bash setup-auto-update.sh /opt/polybot 60
```

### 开发/测试环境

```bash
# 每 15 分钟检查一次（快速迭代）
bash setup-auto-update.sh /opt/polybot 15
```

## 监控建议

### 监控更新状态

```bash
# 定期检查更新日志
watch -n 60 'tail -20 /opt/polybot/logs/auto-update.log'
```

### 监控服务状态

```bash
# 如果使用 PM2
pm2 monit
```

---

**设置完成后，代码会自动保持最新，无需手动操作！**
