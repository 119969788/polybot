# 🔧 交易失败故障排除指南

## 当前问题

交易失败示例：
```
🔄 跟单交易: gabagool22
   操作: BUY Up
   价格: $0.66
   数量: 8.42 份额
   结果: ❌ 失败
```

## 常见失败原因及解决方案

### 1. 账户余额不足

**症状**：
- 错误信息包含 "insufficient" 或 "balance"
- 交易金额大于账户余额

**解决方案**：
```bash
# 检查账户余额
# 需要确保账户有足够的 USDC 余额
# 至少要有：最大单笔金额 + 手续费
```

**配置调整**：
```javascript
// config.js
followSettings: {
  maxSizePerTrade: 10,  // 减小最大单笔金额
  minTradeSize: 1,      // 确保最小值合理
}
```

### 2. 价格变动（滑点过大）

**症状**：
- 错误信息包含 "slippage" 或 "price"
- FOK 订单无法成交

**解决方案**：

**方案 A：增加滑点容忍度**
```javascript
// config.js
followSettings: {
  maxSlippage: 0.05,  // 从 3% 增加到 5%
}
```

**方案 B：改用 FAK 订单类型**
```javascript
// config.js
followSettings: {
  orderType: 'FAK',  // 允许部分成交
}
```

### 3. 交易金额过小

**症状**：
- 错误信息包含 "min" 或 "minimum size"
- 交易金额小于平台最小要求

**解决方案**：
```javascript
// config.js
followSettings: {
  minTradeSize: 1,  // Polymarket 最小是 $1
}
```

### 4. FOK 订单无法全部成交

**症状**：
- 使用 FOK（全部成交或取消）订单类型
- 市场深度不足，无法全部成交

**解决方案**：
```javascript
// config.js
followSettings: {
  orderType: 'FAK',  // 改为允许部分成交
  // 或
  maxSlippage: 0.05,  // 增加滑点容忍度
}
```

### 5. 网络连接问题

**症状**：
- 错误信息包含 "network"、"timeout" 或 "connection"
- 请求超时

**解决方案**：

**配置代理**（如果在中国大陆）：
```bash
export HTTP_PROXY="http://127.0.0.1:7890"
export HTTPS_PROXY="http://127.0.0.1:7890"
npm start
```

**或使用启动脚本**：
```bash
./start-proxy.ps1  # Windows
# 或
bash start-proxy.sh  # Linux
```

### 6. 市场已关闭或条件不存在

**症状**：
- 错误信息包含 "market"、"condition" 或 "not found"
- 市场可能已关闭或条件已过期

**解决方案**：
- 这是正常的，某些市场可能已关闭
- 程序会自动跳过这些交易

### 7. API 限制或限流

**症状**：
- 错误信息包含 "rate limit"、"too many requests"
- 请求过于频繁

**解决方案**：
```javascript
// config.js
followSettings: {
  watchInterval: 10000,  // 增加监听间隔（毫秒）
}
```

### 8. 测试模式下的失败

**症状**：
- `dryRun: true` 时，交易可能显示失败
- 这是正常的，因为测试模式下不会真正执行交易

**解决方案**：
- 如果需要在真实环境测试，设置 `dryRun: false`
- ⚠️ **注意**：这会执行真实交易

## 改进后的错误处理

我已经改进了错误处理，现在会：

1. ✅ **显示详细错误信息**
   - 显示具体的错误消息
   - 根据错误类型提供解决建议

2. ✅ **记录失败交易**
   - 失败交易会被记录到盈利统计中
   - 可以分析失败原因和模式

3. ✅ **提供解决建议**
   - 根据错误类型自动提供修复建议
   - 帮助快速定位和解决问题

## 诊断步骤

### 步骤 1：查看详细错误

改进后的日志会显示：
```
   结果: ❌ 失败
   错误信息: [具体错误]
   💡 建议: [解决建议]
```

### 步骤 2：检查配置

```bash
# 检查配置
node test-config.js
```

确保：
- ✅ 账户有足够的 USDC 余额
- ✅ `minTradeSize` >= 1
- ✅ `maxSizePerTrade` 合理
- ✅ `maxSlippage` 设置合理

### 步骤 3：检查账户状态

```bash
# 需要 SDK 支持查询余额功能
# 或手动检查 Polymarket 账户余额
```

### 步骤 4：调整配置

根据错误类型调整配置：

```javascript
// 如果余额不足
maxSizePerTrade: 5,  // 减小金额

// 如果滑点问题
maxSlippage: 0.05,   // 增加滑点
orderType: 'FAK',    // 改用 FAK

// 如果网络问题
// 配置代理
```

## 失败交易统计

改进后的代码会：

1. ✅ 记录所有失败交易
2. ✅ 分析失败原因
3. ✅ 在盈利统计中显示失败率
4. ✅ 帮助识别常见失败模式

## 快速修复建议

根据您的情况（BUY Up, $0.66, 8.42 份额），可能的原因：

### 最可能的原因

1. **FOK 订单无法全部成交**
   - 解决方案：改用 FAK 订单类型

2. **账户余额不足**
   - 解决方案：检查余额，或减小 `maxSizePerTrade`

3. **滑点过大**
   - 解决方案：增加 `maxSlippage`

### 快速修复配置

```javascript
// config.js
followSettings: {
  orderType: 'FAK',      // 改为 FAK（允许部分成交）
  maxSlippage: 0.05,     // 增加滑点到 5%
  maxSizePerTrade: 10,   // 确保金额合理
  minTradeSize: 1,       // 最小 $1
}
```

## 查看失败交易统计

程序运行一段时间后，可以查看失败交易统计：

```bash
# 程序退出时会显示
# 或按 Ctrl+C 退出时查看完整统计
```

统计中会包括：
- 总交易数
- 成功交易数
- 失败交易数
- 失败原因分析

---

**建议：先查看详细错误信息，然后根据错误类型调整配置！**
