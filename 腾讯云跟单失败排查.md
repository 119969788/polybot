# 🔧 腾讯云跟单失败排查指南

## 快速诊断

### 步骤 1：运行诊断工具

```bash
cd /opt/polybot
node 诊断跟单失败.js
```

诊断工具会自动检查：
- ✅ SDK 初始化状态
- ✅ 配置参数（订单类型、滑点、金额等）
- ✅ 目标钱包配置
- ✅ 账户状态
- ✅ 网络连接
- ✅ 运行模式

### 步骤 2：查看详细错误日志

```bash
# 如果使用 PM2
pm2 logs polybot --lines 100 --err

# 或直接运行查看实时日志
npm start
```

改进后的错误日志会显示：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 跟单交易: gabagool22
   操作: BUY Up
   价格: $0.66
   数量: 8.42 份额
   金额: $5.56
   结果: ❌ 失败
   错误信息: [具体错误原因]
   💡 建议: [详细解决方案]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 常见失败原因及解决方案

### 1. ❌ 账户余额不足

**症状**：
- 错误信息包含 "insufficient"、"balance" 或 "余额"

**解决方案**：

```bash
# 1. 检查账户余额
# 登录 Polymarket 网站查看 USDC 余额

# 2. 确保余额充足
# 至少需要：最大单笔金额 + 手续费缓冲
# 例如：maxSizePerTrade = 10，建议余额 >= 15
```

**配置调整**：
```javascript
// config.js
followSettings: {
  maxSizePerTrade: 5,  // 减小最大单笔金额
  minTradeSize: 1,
}
```

### 2. ❌ 价格变动（滑点过大）

**症状**：
- 错误信息包含 "slippage"、"price"、"滑点" 或 "价格"

**解决方案**：

```javascript
// config.js
followSettings: {
  maxSlippage: 0.05,  // 从 3% 增加到 5%
  orderType: 'FAK',   // 改用 FAK 允许部分成交
}
```

### 3. ❌ FOK 订单无法全部成交

**症状**：
- 使用 FOK 订单类型
- 市场深度不足，无法全部成交

**解决方案**：

```javascript
// config.js
followSettings: {
  orderType: 'FAK',  // 改为允许部分成交
  // 或
  maxSlippage: 0.05,  // 增加滑点容忍度
}
```

### 4. ❌ 网络连接问题

**症状**：
- 错误信息包含 "network"、"timeout"、"连接" 或 "网络"
- 请求超时

**解决方案**：

**配置代理**（如果在中国大陆）：
```bash
# 在服务器上设置代理
export HTTP_PROXY="http://127.0.0.1:7890"
export HTTPS_PROXY="http://127.0.0.1:7890"

# 或在 config.js 中配置
sdk: {
  proxy: {
    http: 'http://127.0.0.1:7890',
    https: 'http://127.0.0.1:7890',
  },
}
```

**使用启动脚本**：
```bash
# 如果已有代理启动脚本
bash start-proxy.sh
```

### 5. ❌ 交易金额过小

**症状**：
- 错误信息包含 "min"、"size"、"minimum" 或 "最小"

**解决方案**：

```javascript
// config.js
followSettings: {
  minTradeSize: 1,      // Polymarket 最小是 $1
  sizeScale: 0.1,       // 确保跟单比例不会导致金额过小
}
```

### 6. ❌ 市场已关闭或条件不存在

**症状**：
- 错误信息包含 "market"、"condition"、"not found" 或 "不存在"

**解决方案**：
- 这是正常的，某些市场可能已关闭
- 程序会自动跳过这些交易
- 无需处理

### 7. ❌ API 限流

**症状**：
- 错误信息包含 "rate limit"、"too many" 或 "限流"

**解决方案**：

```javascript
// config.js
followSettings: {
  watchInterval: 10000,  // 增加监听间隔（毫秒）
}
```

## 推荐配置（提高成功率）

```javascript
// config.js
followSettings: {
  // 订单类型：使用 FAK 允许部分成交
  orderType: 'FAK',
  
  // 滑点容忍度：5%
  maxSlippage: 0.05,
  
  // 金额设置
  maxSizePerTrade: 10,  // 根据余额调整
  minTradeSize: 1,      // 最小 $1
  
  // 跟单比例
  sizeScale: 0.1,       // 10%
  
  // 自动跟单
  autoFollow: true,
  
  // 测试模式（先测试）
  dryRun: true,
}
```

## 诊断流程

### 完整排查步骤

```bash
# 1. 运行诊断工具
cd /opt/polybot
node 诊断跟单失败.js

# 2. 查看最新日志
pm2 logs polybot --lines 50

# 3. 检查配置
grep -A 10 "followSettings" config.js

# 4. 验证语法
node --check config.js
node --check src/WalletFollower.js

# 5. 检查账户余额（手动）
# 登录 Polymarket 网站查看

# 6. 测试网络连接
curl -I https://polymarket.com

# 7. 重启服务
pm2 restart polybot
```

## 快速修复脚本

创建快速修复脚本：

```bash
# 快速修复配置
cat > /opt/polybot/快速修复配置.sh << 'EOF'
#!/bin/bash
cd /opt/polybot

# 备份配置
cp config.js config.js.backup.$(date +%Y%m%d_%H%M%S)

# 使用 sed 修改配置（如果使用 FAK 和 5% 滑点）
# 注意：这需要根据实际情况调整

echo "✅ 配置已备份"
echo "💡 请手动编辑 config.js 调整以下参数："
echo "   - orderType: 'FAK'"
echo "   - maxSlippage: 0.05"
echo "   - maxSizePerTrade: 10（根据余额调整）"
EOF

chmod +x /opt/polybot/快速修复配置.sh
```

## 查看失败交易统计

程序会记录所有失败交易，退出时显示统计：

```bash
# 按 Ctrl+C 退出程序，会显示：
# - 总交易数
# - 成功交易数
# - 失败交易数
# - 失败原因分析
```

## 启用详细调试

查看更详细的错误信息：

```bash
# 设置调试模式
export DEBUG=true
npm start

# 或使用 PM2
pm2 restart polybot --update-env --env DEBUG=true
```

## 常见问题

### Q: 为什么测试模式下也显示失败？

A: 测试模式（`dryRun: true`）下，交易可能显示失败，这是正常的。测试模式不会执行真实交易，只是模拟。

### Q: 如何确认是真实失败还是测试模式？

A: 检查配置中的 `dryRun` 值：
- `dryRun: true` = 测试模式（失败是正常的）
- `dryRun: false` = 真实模式（失败需要排查）

### Q: 失败率很高怎么办？

A: 
1. 运行诊断工具检查配置
2. 改用 FAK 订单类型
3. 增加滑点容忍度
4. 检查账户余额
5. 减小最大单笔金额

### Q: 如何查看具体的错误信息？

A: 
1. 查看 PM2 日志：`pm2 logs polybot`
2. 直接运行：`npm start`（查看实时输出）
3. 启用调试：`DEBUG=true npm start`

## 联系支持

如果以上方法都无法解决问题：

1. ✅ 运行诊断工具：`node 诊断跟单失败.js`
2. ✅ 收集错误日志：`pm2 logs polybot --lines 100 > error.log`
3. ✅ 检查配置：`cat config.js`
4. ✅ 提供以上信息以便进一步诊断

---

**建议：先运行诊断工具，根据结果调整配置！**
