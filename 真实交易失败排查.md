# 🔍 真实交易失败排查指南

## 问题描述

- ✅ 模拟跟单交易成功（`dryRun: true`）
- ❌ 真实交易跟单全部失败（`dryRun: false`）

这说明代码逻辑正确，但真实交易遇到了实际问题。

## 常见原因及解决方案

### 原因 1: USDC.e 代币未授权（最常见）

**症状：**
- 模拟交易成功
- 真实交易失败，可能没有明确错误信息

**解决方法：**
1. 登录 Polymarket 网站：https://polymarket.com
2. 连接钱包（确保在 Polygon 主网）
3. 尝试买入任意市场
4. 如果弹出授权提示，点击 "Approve" 或 "授权"
5. 在钱包中确认交易（需要支付少量 Gas 费用）
6. 等待交易确认（通常几秒到几分钟）

**验证：**
- 再次尝试买入，如果不再提示授权，说明授权成功

详细步骤见：`USDC授权指南.md`

### 原因 2: 余额不足

**检查：**
```bash
# 手动登录 Polymarket 检查 USDC 余额
# 确保余额 >= maxSizePerTrade + 手续费（建议多留 10-20% 缓冲）
```

**解决方法：**
- 充值 USDC 到账户
- 或减小 `maxSizePerTrade` 配置

**建议余额：**
- 至少 `maxSizePerTrade * 1.2`（加上 20% 缓冲）
- 例如：如果 `maxSizePerTrade: 10`，建议余额至少 `$12`

### 原因 3: 订单类型（FOK）

**检查：**
```bash
cd /opt/polybot
grep "orderType" config.js
```

**如果显示 `orderType: 'FOK'`：**
- FOK 要求全部成交，否则失败
- 在真实市场中可能无法全部成交

**解决方法：**
修改 `config.js`：
```javascript
orderType: 'FAK',  // 改为 FAK，允许部分成交
```

### 原因 4: 滑点容忍度过小

**检查：**
```bash
grep "maxSlippage" config.js
```

**如果显示 `maxSlippage: 0.03` 或更小：**
- 3% 滑点可能过小，真实市场价格变动更快

**解决方法：**
增加滑点容忍度：
```javascript
maxSlippage: 0.05,  // 改为 5%
// 如果仍然失败，可以尝试 0.07 (7%) 或 0.10 (10%)
```

### 原因 5: 钱包未在 Polymarket 注册

**症状：**
- SDK 初始化可能失败
- 日志中可能显示 "交易服务不可用"

**检查：**
1. 使用私钥对应的钱包地址登录 Polymarket
2. 完成账户注册流程
3. 验证钱包地址是否正确

**解决方法：**
- 使用钱包地址登录 Polymarket
- 完成注册流程
- 重新运行程序

### 原因 6: 网络连接问题

**检查：**
```bash
# 测试网络连接
curl -I https://polymarket.com

# 查看错误日志
pm2 logs polybot --err | grep -i "network\|timeout\|connection"
```

**解决方法：**
- 检查服务器网络连接
- 配置代理（如果在中国大陆）：
  ```bash
  export HTTP_PROXY=http://127.0.0.1:7890
  export HTTPS_PROXY=http://127.0.0.1:7890
  pm2 restart polybot --update-env
  ```

### 原因 7: Gas 费用不足（MATIC）

**检查：**
- 确保钱包中有足够的 MATIC 支付 Gas 费用
- 建议至少 0.1 MATIC

**解决方法：**
- 充值 MATIC 到钱包
- Gas 费用通常每次交易 0.001-0.01 MATIC

## 推荐的真实交易配置

```javascript
// config.js
followSettings: {
  autoFollow: true,
  dryRun: false,           // ✅ 真实交易模式
  orderType: 'FAK',        // ✅ 允许部分成交（推荐）
  maxSlippage: 0.05,       // ✅ 5% 滑点（推荐）
  maxSizePerTrade: 10,     // ✅ 根据余额调整
  minTradeSize: 1,         // ✅ 最小 $1
  sizeScale: 0.1,          // ✅ 跟单 10%
}
```

## 完整排查流程

### 步骤 1: 检查配置

```bash
cd /opt/polybot

# 检查关键配置
cat config.js | grep -E "dryRun|orderType|maxSlippage|maxSizePerTrade"
```

**确认：**
- `dryRun: false`（真实交易模式）
- `orderType: 'FAK'`（推荐）
- `maxSlippage: 0.05`（推荐 5%）

### 步骤 2: 检查授权状态

1. 登录 Polymarket 网站
2. 尝试买入任意市场
3. 如果提示授权，完成授权流程

### 步骤 3: 检查余额

1. 登录 Polymarket 检查 USDC 余额
2. 确保余额 >= `maxSizePerTrade * 1.2`
3. 确保有足够的 MATIC 支付 Gas

### 步骤 4: 运行诊断工具

```bash
cd /opt/polybot
node diagnose-failures.js
```

### 步骤 5: 查看详细错误日志

```bash
# 查看完整错误日志
pm2 logs polybot --err --lines 100

# 查看包含"失败"的完整上下文
pm2 logs polybot --lines 200 | grep -B 5 -A 15 "失败"
```

### 步骤 6: 启用调试模式

```bash
# 启用调试模式
DEBUG=true pm2 restart polybot --update-env

# 查看日志
pm2 logs polybot
```

## 分步测试建议

### 阶段 1: 小金额测试

```javascript
followSettings: {
  dryRun: false,           // 真实交易
  orderType: 'FAK',        // 允许部分成交
  maxSlippage: 0.05,       // 5% 滑点
  maxSizePerTrade: 1,      // ✅ 最小金额 $1
  minTradeSize: 1,
  sizeScale: 0.1,
}
```

**测试步骤：**
1. 使用最小金额配置
2. 运行程序
3. 观察是否成功
4. 如果成功，逐步增加金额

### 阶段 2: 逐步增加金额

如果小金额测试成功：
- `maxSizePerTrade: 5`（$5）
- `maxSizePerTrade: 10`（$10）
- 根据实际情况继续调整

## 快速修复命令

### 应用推荐配置

```bash
cd /opt/polybot

# 备份配置
cp config.js config.js.bak

# 修改订单类型为 FAK
sed -i "s/orderType: 'FOK'/orderType: 'FAK'/" config.js
sed -i 's/orderType: "FOK"/orderType: "FAK"/' config.js

# 修改滑点为 0.05
sed -i 's/maxSlippage: 0.03/maxSlippage: 0.05/' config.js
sed -i 's/maxSlippage: 0.02/maxSlippage: 0.05/' config.js

# 验证修改
grep -E "orderType|maxSlippage" config.js

# 重启程序
pm2 restart polybot

# 查看日志
pm2 logs polybot --lines 50
```

## 优先级建议

按优先级检查：

1. **🔴 最高优先级：USDC.e 授权**
   - 这是最常见的原因
   - 模拟交易成功但真实交易失败，通常是授权问题

2. **🟡 高优先级：余额检查**
   - 确保有足够的 USDC 和 MATIC

3. **🟡 高优先级：订单类型和滑点**
   - 使用 FAK 而不是 FOK
   - 增加滑点容忍度

4. **🟢 中优先级：网络连接**
   - 检查网络是否正常

5. **🟢 低优先级：钱包注册**
   - 确认钱包已在 Polymarket 注册

## 验证修复

修复后验证：

```bash
# 1. 查看配置
grep -E "dryRun|orderType|maxSlippage" config.js

# 2. 重启程序
pm2 restart polybot

# 3. 查看日志
pm2 logs polybot --lines 50

# 4. 观察交易结果
# 应该看到成功的交易或更详细的错误信息
```

## 获取帮助

如果以上方法都无法解决：

1. 保存完整的错误日志
2. 记录失败的交易详情
3. 运行诊断工具并保存结果
4. 查看具体错误信息进行调整

## 总结

**最常见的解决方案：**

1. ✅ **授权 USDC.e 代币**（最重要！）
2. ✅ 改为 `orderType: 'FAK'`
3. ✅ 增加 `maxSlippage: 0.05`
4. ✅ 检查余额是否充足
5. ✅ 确保有足够的 MATIC 支付 Gas

按照这个顺序检查，通常可以解决大部分问题。
