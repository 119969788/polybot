# 🖥️ 腾讯云服务器部署盈利统计功能

## 概述

盈利统计功能已完全集成到代码中，部署到服务器时会自动包含。以下是部署和配置指南。

## 文件清单

确保以下文件都上传到服务器：

### 必需文件

```
polybot/
├── src/
│   ├── ProfitTracker.js      ✅ 新增：盈利统计核心类
│   └── WalletFollower.js     ✅ 已更新：集成了盈利统计
├── config.js                 ✅ 已更新：包含 profitTracking 配置
├── index.js                  ✅ 已更新：支持统计显示
└── package.json              ✅ 无需修改（无新依赖）
```

### 自动生成文件（不需要上传）

```
data/
└── profit-history.json       ⚠️ 服务器运行后自动生成
```

## 部署步骤

### 1. 更新服务器代码

#### 方法一：Git Pull（如果使用 Git）

```bash
# SSH 连接到服务器
ssh user@your-server-ip

# 进入项目目录
cd /opt/polybot

# 拉取最新代码
git pull origin main

# 检查新文件
ls -la src/ProfitTracker.js
```

#### 方法二：手动上传文件

如果需要手动上传：

```bash
# 在本地
scp src/ProfitTracker.js user@your-server-ip:/opt/polybot/src/
scp src/WalletFollower.js user@your-server-ip:/opt/polybot/src/
scp config.js user@your-server-ip:/opt/polybot/
scp index.js user@your-server-ip:/opt/polybot/
```

### 2. 验证文件

在服务器上验证文件：

```bash
cd /opt/polybot

# 检查文件是否存在
ls -la src/ProfitTracker.js
ls -la src/WalletFollower.js

# 检查语法
node --check src/ProfitTracker.js
node --check src/WalletFollower.js
node --check config.js
```

### 3. 确保配置正确

检查 `config.js` 中的盈利统计配置：

```bash
# 查看配置
grep -A 5 "profitTracking" config.js
```

应该看到：

```javascript
profitTracking: {
  enabled: true,
  autoSaveInterval: 60000,
  displayInterval: 30,
}
```

### 4. 创建数据目录

```bash
# 创建数据目录（如果不存在）
mkdir -p /opt/polybot/data

# 设置权限
chmod 755 /opt/polybot/data
```

### 5. 测试运行

```bash
# 测试运行（检查是否有错误）
node index.js

# 按 Ctrl+C 停止后，检查是否生成了数据文件
ls -la data/profit-history.json
```

### 6. 使用 PM2 运行

如果使用 PM2：

```bash
# 停止现有进程
pm2 stop polybot

# 重启进程（会自动加载新代码）
pm2 restart polybot

# 查看日志
pm2 logs polybot --lines 50

# 查看进程状态
pm2 status
```

## 配置说明

### 默认配置（推荐）

```javascript
profitTracking: {
  enabled: true,              // 启用盈利统计
  autoSaveInterval: 60000,    // 1分钟自动保存
  displayInterval: 30,        // 30分钟显示一次统计
}
```

### 自定义配置

如果需要调整：

```bash
# 编辑配置文件
nano /opt/polybot/config.js
```

修改 `profitTracking` 部分：

```javascript
profitTracking: {
  enabled: true,                    // 启用/禁用
  autoSaveInterval: 300000,        // 5分钟保存一次
  displayInterval: 60,             // 1小时显示一次（0=不自动显示）
}
```

## 验证部署

### 检查功能是否正常

运行程序后，应该看到：

```
🚀 初始化钱包跟单系统...
✅ 初始化完成，正在监听 2 个钱包
📊 盈利统计: 已启用
```

### 检查数据文件

运行一段时间后，检查数据文件：

```bash
# 查看数据文件
ls -lh data/profit-history.json

# 查看文件内容（如果有数据）
cat data/profit-history.json | head -20
```

### 测试统计显示

程序运行中，等待一段时间后，应该会看到定期统计输出。

或者按 `Ctrl+C` 退出时，应该看到完整的盈利统计报告。

## 数据备份

### 手动备份

```bash
# 备份盈利数据
cp data/profit-history.json data/profit-history.json.backup.$(date +%Y%m%d)

# 或压缩备份
tar -czf profit-data-backup-$(date +%Y%m%d).tar.gz data/
```

### 自动备份脚本

创建自动备份脚本 `/opt/polybot/backup-profit.sh`：

```bash
#!/bin/bash
BACKUP_DIR="/opt/polybot/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

if [ -f "data/profit-history.json" ]; then
    cp data/profit-history.json $BACKUP_DIR/profit-history-$DATE.json
    echo "✅ 备份完成: profit-history-$DATE.json"
    
    # 只保留最近 30 天的备份
    find $BACKUP_DIR -name "profit-history-*.json" -mtime +30 -delete
else
    echo "⚠️  数据文件不存在"
fi
```

添加到 crontab（每天备份一次）：

```bash
# 编辑 crontab
crontab -e

# 添加（每天凌晨 2 点备份）
0 2 * * * cd /opt/polybot && bash backup-profit.sh >> /var/log/profit-backup.log 2>&1
```

## 查看统计报告

### 方法一：运行时查看

程序运行中，等待自动显示（默认每 30 分钟）。

### 方法二：退出时查看

按 `Ctrl+C` 退出程序，会自动显示完整统计。

### 方法三：从数据文件查看

```bash
# 安装 jq（如果还没有）
apt-get install jq  # 或 yum install jq

# 查看统计摘要
cat data/profit-history.json | jq '{
  totalTrades: .totalTrades,
  netProfit: .netProfit,
  winRate: (.winningTrades / (.winningTrades + .losingTrades) * 100)
}'
```

### 方法四：创建查看脚本

创建 `/opt/polybot/view-stats.js`：

```javascript
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const dataFile = join(__dirname, 'data', 'profit-history.json');

try {
  const data = JSON.parse(readFileSync(dataFile, 'utf-8'));
  const winRate = data.totalTrades > 0 
    ? ((data.winningTrades / (data.winningTrades + data.losingTrades)) * 100).toFixed(2)
    : 0;
  
  console.log('📊 盈利统计摘要:');
  console.log(`   总交易: ${data.totalTrades}`);
  console.log(`   盈利交易: ${data.winningTrades}`);
  console.log(`   亏损交易: ${data.losingTrades}`);
  console.log(`   胜率: ${winRate}%`);
  console.log(`   净利润: $${data.netProfit.toFixed(2)}`);
} catch (error) {
  console.error('❌ 读取数据失败:', error.message);
}
```

运行：

```bash
node view-stats.js
```

## 常见问题

### 问题 1：数据文件无法创建

**原因**：目录权限不足

**解决**：

```bash
# 检查目录权限
ls -ld data/

# 设置正确权限
chmod 755 data/
chown -R $USER:$USER data/
```

### 问题 2：统计不显示

**检查配置**：

```bash
grep "displayInterval" config.js
```

如果为 0，需要设置一个大于 0 的值。

### 问题 3：数据丢失

**预防**：

1. 定期备份 `data/profit-history.json`
2. 使用 cron 自动备份
3. 程序会在退出时自动保存

## PM2 配置建议

如果使用 PM2，建议配置：

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'polybot',
    script: 'index.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
  }]
};
```

运行：

```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

## 监控建议

### 监控数据文件大小

```bash
# 检查文件大小
du -h data/profit-history.json

# 如果文件过大（>100MB），可能需要清理旧数据
```

### 监控程序运行

```bash
# PM2 监控
pm2 monit

# 查看日志
pm2 logs polybot --lines 100
```

## 快速部署检查清单

- [ ] ✅ 更新代码到服务器
- [ ] ✅ 验证 `src/ProfitTracker.js` 存在
- [ ] ✅ 验证 `config.js` 包含 `profitTracking` 配置
- [ ] ✅ 创建 `data/` 目录
- [ ] ✅ 测试运行无错误
- [ ] ✅ 配置自动备份（可选）
- [ ] ✅ 重启 PM2 进程（如果使用）

---

**部署完成后，盈利统计功能会自动工作，无需额外配置！**
