# 🔍 排查连续跟单失败问题

## 问题描述

多个跟单交易连续失败，但未显示详细错误信息：

```
🔄 跟单交易: gabagool22
   操作: BUY Up
   价格: $0.89
   数量: 9 份额
   结果: ❌ 失败
```

## 排查步骤

### 步骤 1: 查看完整错误日志

```bash
# 查看完整日志（包括错误信息）
pm2 logs polybot --lines 200

# 查看错误日志
pm2 logs polybot --err --lines 100

# 或者实时查看日志
pm2 logs polybot
```

### 步骤 2: 检查是否在测试模式

如果 `dryRun: true`（测试模式），失败是正常的，因为不会执行真实交易。

检查配置文件：
```bash
cd /opt/polybot
grep "dryRun" config.js
```

### 步骤 3: 运行诊断工具

```bash
cd /opt/polybot
node diagnose-failures.js
```

### 步骤 4: 检查常见原因

#### 可能原因 1: 余额不足

**检查：**
```bash
# 手动登录 Polymarket 检查 USDC 余额
# 确保余额 >= maxSizePerTrade + 手续费
```

**解决：**
- 充值 USDC 到账户
- 或减小 `maxSizePerTrade` 配置

#### 可能原因 2: 订单类型（FOK）

**检查：**
```bash
grep "orderType" config.js
```

**解决：**
修改 `config.js`：
```javascript
orderType: 'FAK',  // 改为 FAK，允许部分成交
```

#### 可能原因 3: 滑点过大

**检查：**
```bash
grep "maxSlippage" config.js
```

**解决：**
增加滑点容忍度：
```javascript
maxSlippage: 0.05,  // 改为 5%
```

#### 可能原因 4: 未授权 USDC.e

**检查：**
- 登录 Polymarket 网站
- 尝试买入任意市场
- 如果提示授权，需要先授权 USDC.e

**解决：**
- 按照授权提示完成 USDC.e 授权
- 详细步骤见 `USDC授权指南.md`

#### 可能原因 5: 网络连接问题

**检查：**
```bash
# 测试网络连接
curl -I https://polymarket.com

# 查看是否有网络错误
pm2 logs polybot --err | grep -i "network\|timeout\|connection"
```

**解决：**
- 检查服务器网络连接
- 配置代理（如果在中国大陆）

#### 可能原因 6: 测试模式（正常）

如果 `dryRun: true`，失败是正常的，因为不会执行真实交易。

**确认：**
```bash
grep "dryRun" config.js
```

**解决：**
- 如果是测试模式，失败是预期的
- 切换到实盘模式：`dryRun: false`

### 步骤 5: 查看详细错误信息

如果日志中没有显示详细错误信息，可能需要：

1. **启用调试模式：**
   ```bash
   DEBUG=true pm2 restart polybot --update-env
   pm2 logs polybot
   ```

2. **查看完整日志：**
   ```bash
   pm2 logs polybot --lines 500 | grep -A 10 "失败"
   ```

3. **检查错误日志文件：**
   ```bash
   tail -n 100 ~/.pm2/logs/polybot-error.log
   ```

## 推荐的修复配置

```javascript
// config.js
followSettings: {
  autoFollow: true,
  dryRun: false,          // 实盘模式（如果已测试过）
  orderType: 'FAK',       // 允许部分成交
  maxSlippage: 0.05,      // 5% 滑点
  maxSizePerTrade: 10,    // 根据余额调整
  minTradeSize: 1,        // 最小 $1
  sizeScale: 0.1,         // 跟单 10%
}
```

## 快速排查命令

```bash
cd /opt/polybot

# 1. 查看配置
cat config.js | grep -E "dryRun|orderType|maxSlippage|maxSizePerTrade"

# 2. 运行诊断工具
node diagnose-failures.js

# 3. 查看最近错误日志
pm2 logs polybot --err --lines 100

# 4. 查看完整日志
pm2 logs polybot --lines 200 | grep -B 5 -A 10 "失败"

# 5. 检查数据文件（如果有失败记录）
cat data/profit-history.json | grep -A 5 "FAILED"
```

## 根据错误信息调整

查看完整错误信息后，根据具体错误调整配置：

- **余额不足** → 充值或减小金额
- **滑点过大** → 增加 maxSlippage
- **FOK 失败** → 改用 FAK
- **未授权** → 授权 USDC.e
- **网络问题** → 检查网络或配置代理
- **测试模式** → 切换到实盘模式

## 获取帮助

如果以上方法都无法解决：

1. 保存完整的错误日志
2. 记录失败的交易详情
3. 运行诊断工具并保存结果
4. 查看具体错误信息进行调整
