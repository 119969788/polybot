# 🔧 实盘跟单失败排查指南

## 问题描述

实盘跟单交易失败，需要排查可能的原因。

## 快速排查步骤

### 1. 运行诊断工具

```bash
cd /opt/polybot
npm run diagnose
```

诊断工具会检查：
- SDK 初始化状态
- 配置参数（订单类型、滑点、金额等）
- 目标钱包配置
- 账户状态
- 网络连接
- 运行模式
- 自动跟单配置

### 2. 查看详细错误日志

运行跟单程序时，注意观察错误信息：

```bash
cd /opt/polybot
npm start
```

常见错误信息：
- `余额不足` / `Insufficient balance`
- `滑点过大` / `Slippage too large`
- `订单无法全部成交` / `Fill or Kill failed`
- `价格变动过快` / `Price moved`
- `市场深度不足` / `Insufficient liquidity`

### 3. 检查配置文件

确保 `config.js` 中的配置正确：

```javascript
followSettings: {
  autoFollow: true,        // ✅ 必须启用
  dryRun: false,           // ✅ 实盘模式必须为 false
  orderType: 'FAK',        // ✅ 推荐 FAK（允许部分成交）
  maxSlippage: 0.05,       // ✅ 推荐 5%（提高成功率）
  maxSizePerTrade: 10,     // ✅ 根据余额调整
  minTradeSize: 1,         // ✅ 最小 $1
  sizeScale: 0.1,          // ✅ 跟单 10%
}
```

## 常见失败原因及解决方案

### 问题 1: 余额不足

**错误信息：**
- `Insufficient balance`
- `余额不足`
- `Not enough USDC`

**解决方案：**
1. 检查 Polymarket 账户 USDC 余额
2. 确保余额 >= `maxSizePerTrade + 手续费`（建议多留 10-20% 缓冲）
3. 如果余额不足，充值 USDC 到账户

**检查命令：**
```bash
# 手动登录 Polymarket 检查余额
# 或使用浏览器访问：https://polymarket.com
```

### 问题 2: 订单类型导致失败（FOK）

**错误信息：**
- `Fill or Kill failed`
- `无法全部成交`
- `Order not filled completely`

**解决方案：**
修改 `config.js`：

```javascript
followSettings: {
  orderType: 'FAK',  // 改为 FAK，允许部分成交
  // ... 其他配置
}
```

**说明：**
- `FOK` (Fill Or Kill): 必须全部成交，否则取消（容易失败）
- `FAK` (Fill And Kill): 允许部分成交（推荐，成功率更高）

### 问题 3: 滑点过大

**错误信息：**
- `Slippage too large`
- `价格变动过大`
- `Price moved beyond tolerance`

**解决方案：**
增加滑点容忍度：

```javascript
followSettings: {
  maxSlippage: 0.05,  // 改为 5%（从 3% 增加）
  // 如果仍然失败，可以尝试 0.07 (7%) 或 0.10 (10%)
  // 但注意：滑点越大，成交价可能越差
}
```

### 问题 4: 市场深度不足

**错误信息：**
- `Insufficient liquidity`
- `市场深度不足`
- `Order size too large for market`

**解决方案：**
1. 减小单笔交易金额：

```javascript
followSettings: {
  maxSizePerTrade: 5,  // 从 10 改为 5
  // ... 其他配置
}
```

2. 或减小跟单比例：

```javascript
followSettings: {
  sizeScale: 0.05,  // 从 0.1 (10%) 改为 0.05 (5%)
  // ... 其他配置
}
```

### 问题 5: 钱包未在 Polymarket 注册

**错误信息：**
- `Wallet not registered`
- `交易服务不可用`
- `Trading service unavailable`

**解决方案：**
1. 使用私钥对应的钱包地址登录 Polymarket
2. 完成账户注册流程
3. 验证钱包地址是否正确

### 问题 6: 网络连接问题

**错误信息：**
- `Network error`
- `Connection timeout`
- `API 请求失败`

**解决方案：**
1. 检查网络连接
2. 如果在中国大陆，可能需要配置代理：

```bash
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890
npm start
```

3. 或在 `config.js` 中配置代理：

```javascript
sdk: {
  proxy: {
    http: 'http://127.0.0.1:7890',
    https: 'http://127.0.0.1:7890',
  },
}
```

### 问题 7: 配置错误

**常见配置错误：**
- `autoFollow: false`（未启用自动跟单）
- `dryRun: true`（仍在测试模式）
- `orderType` 未设置或设置错误
- `maxSlippage` 过小

**解决方案：**
运行诊断工具检查配置：

```bash
npm run diagnose
```

## 推荐的实盘配置

```javascript
// config.js
export default {
  sdk: {
    privateKey: '0x你的私钥',  // ✅ 必须配置
    chainId: 137,
  },
  followSettings: {
    autoFollow: true,        // ✅ 启用自动跟单
    dryRun: false,           // ✅ 实盘模式
    orderType: 'FAK',        // ✅ 允许部分成交
    maxSlippage: 0.05,       // ✅ 5% 滑点
    maxSizePerTrade: 10,     // ✅ 根据余额调整
    minTradeSize: 1,         // ✅ 最小 $1
    sizeScale: 0.1,          // ✅ 跟单 10%
  },
}
```

## 分步测试建议

### 步骤 1: 测试模式验证

1. 先设置 `dryRun: true`（测试模式）
2. 运行程序，观察日志
3. 确认能够检测到交易并准备跟单

### 步骤 2: 小金额实盘测试

1. 设置 `dryRun: false`（实盘模式）
2. 设置 `maxSizePerTrade: 1`（最小金额）
3. 设置 `orderType: 'FAK'`（允许部分成交）
4. 设置 `maxSlippage: 0.05`（5% 滑点）
5. 运行程序，观察是否成功

### 步骤 3: 逐步增加金额

如果小金额测试成功，逐步增加：

1. `maxSizePerTrade: 5`（$5）
2. `maxSizePerTrade: 10`（$10）
3. 根据实际情况继续调整

## 查看详细错误日志

程序运行时会显示详细的错误信息，包括：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 跟单交易: trader-name
   操作: BUY Up
   价格: $0.66
   数量: 8.42 份额
   金额: $5.56
   结果: ❌ 失败
   错误信息: [具体错误信息]
   建议: [针对性的建议]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

根据错误信息调整配置。

## 获取帮助

如果以上方法都无法解决问题：

1. 保存完整的错误日志
2. 记录失败的交易详情
3. 检查 Polymarket 官方文档
4. 查看 SDK 文档：https://github.com/cyl19970726/poly-sdk
